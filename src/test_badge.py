import board, neopixel, displayio, digitalio
from time import sleep
from fourwire import FourWire
from busio import SPI
from traceback import print_exception
from adafruit_st7735r import ST7735R
from pdepd import EPD_DRIVER

def loop_forever():
    while True:
        sleep(1)

def test_neopixels(pixels):
    print("Testing Neopixels")
    print("-----------------")

    print("Neopixels: red")
    pixels.fill(0x00FF00)
    sleep(0.5)
    print("Neopixels: green")
    pixels.fill(0xFF0000)
    sleep(0.5)
    print("Neopixels: blue")
    pixels.fill(0x0000FF)
    sleep(0.5)
    print("Neopixels: white")
    pixels.fill(0xFFFFFF)
    sleep(0.5)

def test_buttons(pixels):
    print("Testing Buttons")
    print("---------------")

    b1b = False
    b2b = False
    b3b = False
    b4b = False

    BTN1 = digitalio.DigitalInOut(board.BTN1)
    BTN1.direction = digitalio.Direction.INPUT
    BTN1.pull = digitalio.Pull.UP
    
    BTN2 = digitalio.DigitalInOut(board.BTN2)
    BTN2.direction = digitalio.Direction.INPUT
    BTN2.pull = digitalio.Pull.UP

    BTN3 = digitalio.DigitalInOut(board.BTN3)
    BTN3.direction = digitalio.Direction.INPUT
    BTN3.pull = digitalio.Pull.UP
    
    BTN4 = digitalio.DigitalInOut(board.BTN4)
    BTN4.direction = digitalio.Direction.INPUT
    BTN4.pull = digitalio.Pull.UP

    while not b1b or not b2b or not b3b or not b4b:
        if not BTN1.value and not b1b:
            print('Button 1')
            pixels[3] = 0xFFFF00
            b1b = True
        if not BTN2.value and not b2b:
            print('Button 2')
            pixels[2] = 0xFFFF00
            b2b = True
        if not BTN3.value and not b3b:
            print('Button 3')
            pixels[1] = 0xFFFF00
            b3b = True
        if not BTN4.value and not b4b:
            print('Button 4')
            pixels[0] = 0xFFFF00
            b4b = True
        
        sleep(0.1)

    print("All buttons work!")
    sleep(1)

def test_epd(spi):
    print("Testing EPD")
    print("-----------")
    img = bytearray(
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
        b'\xf8\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
        b'\xfe\x7f\xe0?\xe0\xc1\xe1\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
        b'\xfe\x7f\xe0?\xe0\xc1\xe1\xff\x01\x00\x00\x00\x00\x00\x00\x00\xc0?\x00\x00\x00\x00\x00\x00\x00'
        b'\xfe\xff\xf0\xff\xf8\xc7\xf9\xff\x01\x00\x00\x00\x00\x00\x00\x00\xc0?\x00\x00\x00\x00\x00\x00\x00'
        b'\xfe\xc3\xf0\xff\xf9\xff\xc1?\x00\x00\x00\x00\x00\x00\x00\x00\xc0?\x00\x00\x00\x00\x00\x00\x00'
        b'\xfe\xc3\xf0\xf8\xf9\xff\xc1?\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xf1\x01\x00\x00\x00\x00\x00\x00'
        b'\xfe\xc3\xfc\xf0\xf9\xff\xc1?\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xf1\x01\x00\x00\x00\x00\x00\x00'
        b'\xfe\xc3\xfc\xf0\xf9\xff\xc1?\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xc1\x01\x00\x00\x00\x00\x00\x00'
        b'\xfe\xc3\xfc\xf0\xf9\xff\xc1?\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xc7\x0f\x00\x00\x00\x00\x00\x00'
        b'\xfe\xf3\xfc\xf0\xf9\xff\xc1?\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xc7\x0f\x00\x00\x00\x00\x00\x00'
        b'\xfe\xf7\xf0\xf8\xf9\xff\xc1?\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xc7\x0f\x00\x00\x00\x00\x00\x00'
        b'\xfe\xff\xf0\xff\xf9\xff\xc1?\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xc7\x0f\x00\x00\x00\x00\x00\x00'
        b'\xfe\x7f\xf0\xffx\xfc\xc1?\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xc7\x0f\x00\x00\x00\x00\x00\x00'
        b'\xf8\x0f\xe0?`\xf8\x01\x0f\x00\x00\x00\x00\x00\x00\x00\x00\xf8\xc7\x0f\xfc\x03\x00\x00\x00\x00'
        b'\xf8\x0f\xe0?`\xf8\x01\x0f\x00\x00\x00\x00\x00\x00\x00\x00\xf8\xc7\x0f\xfc\x03\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8\xc7\x0f\xfc\x03\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8?\xfe\x01\xfc\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8?\xfe\x01\xfc\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8?\xfe\x01\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8?\x0e\x00\x00\x1f\xc0\xff\x01'
        b'\xf8\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8?\x0e\x00\x00\x1f\xc0\xff\x01'
        b'\xfe\xff\xe0?\xe0\xc7\xc1\x7f\xc0\xcf\x07\x00\x00\x00\x00\x00\xf8?\x04\x00\x00\x1f\xc0\xff\x01'
        b'\xf0\x7f\xe0?\xe0\xc7\xc1\x7f\xc0\xcf\x07\x00\x00\x00\x00\x00\xf8\xff\x01\x00\x00\xe0?\xc0\xff'
        b'\xf0\x7f\xf0\xff\xf8\xc7\xe1\xff\xf1\xcf\x07\x00\x00\x00\x00\x00\xf8\xff\x01\x00\x00\xe0?\xc0\xff'
        b'\xc0\x1f\xf0\xff\xf9\xc7\xe1\xcf\xf3\xcf\x07\x00\x00\x00\x00\x00\xf8\x7f\x00\x00\x00\x008\x00\xc0'
        b'\xc0\x1f\xf0\xf8\xf9\xc7\xe1\x87\xf1\xcf\x07\x00\x00\x00\x00\x00\xf8?\x00\x00\x00\x00\xf8?\x80'
        b'\xc0\x1f\xfc\xf0\xf9\xc7\xf9\x07\xf1\xcf\x07\x00\x00\x00\x00\x00\xf8?\x00\x00\x00\x00\xf8?\x80'
        b'\xc0\x1f\xfc\xf0\xf9\xc7\xf9\x07\xf0\xff\x07\x00\x00\x00\x00\x00\xf8\x0f\x00\x00\x00\x00\xfe\xff?'
        b'\xc0\x1f\xfc\xf0\xf9\xc7\xf9\x07\xf0\xff\x07\x00\x00\x00\x00\x00\xf8\x07\x00\x00\x00\x00\xff\xff?'
        b'\xc0\x1f\xfc\xf0\xf9\xc7\xf9\x07\xf1\xff\x07\x00\x00\x00\x00\x00\xf8\x07\x00\x00\x00\x00\xff\xff?'
        b'\xc0\x1f\xf0\xf8\xe1\xc7\xe1\x87\xf1\xcf\x07\x00\x00\x00\x00\x00\xf8\x01\x00\x00\x00\x00\xff\xff\xf1'
        b'\xc0\x1f\xf0\xff\xe1\xff\xe1\xcf\xf3\xcf\x07\x00\x00\x00\x00\x00\xf8\x01\x00\x00\x00\x00\xff\xff\xf1'
        b'\xc0\x1f\xf0\xff\xe0\xff\xe1\xff\xf1\xcf\x07\x00\x00\x00\x00\x00\xf8\x01\x00\x00\x00\x00\xff\xff\xf1'
        b'\xc0\x0f\xe0?\xc0\x7f\xc0\x7f\xc0\xc3\x07\x00\x00\x00\x00\x00\xf8\x07\x00\x00\x00\xe0\xc7\xff\xff'
        b'\xc0\x0f\xe0?\xc0\x7f\xc0\x7f\xc0\xc3\x07\x00\x00\x00\x00\x00\xf8\x07\x00\x00\x00\xe0\xc7\xff\xff'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x008\x07\x00\x00\x00\xc0\xc7\xff\xff'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\x06\x00\x00\x00\x00\x07\xf8\xff'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\x06\x00\x00\x00\x00\x07\xf8\xff'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x009\x00\x00\x00\x00\x00\x07\xfe\xff'
        b'\xe0\xf0\xe0\x07\x0f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\xf8\x01\x00\xfc\x03\x00\x00\xff\x7f'
        b'\xe0\xf8\x80\x07\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\xf8\x01\x00\xfc\x03\x00\x00\xff\x7f'
        b'\xf0\xff\x81\x1f\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00\x00\x8c\x03\x00\xe0\xff\x7f'
        b'\xf0\xff\x81\xff\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00\x80\x8f\x1f\x00\xf8\xff\x7f'
        b'\xf0\xff\x01\xff\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00\x80\x8f\x1f\x00\xf8\xff\x7f'
        b'\xf0\xff\x01\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x07\x00\x00\xfc\x03\x008\xfe\x0f'
        b'\xf0\xff\x01\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x07\x00\x00\xfc\x03\x008\xfe\x0f'
        b'\xf0\xff\x01\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x07\x00\x00\xfc\x03\x008\xfe\x0f'
        b'\xfc\xff\x01\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x078\x00\x00\x00\x00\x00\xc0?\x0e'
        b'|\xff\x01\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x078\x00\x00\x00\x00\x00\xc0?\x0e'
        b'<\xfe\x01\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x078\x00\x00\x00\x00\x00\xc0?\x0e'
        b'<\xf0\x07\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00`\x00\xc7\x01\x00\x00\x00\x00\xf8\x07\x0e'
        b'\x1c\xe0\x03\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00`\x00\xc7\x01\x00\x00\x00\x00\xf8\x07\x0e'
        b'\x1c\xe0\x01\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00`\x00\x07\x00\x00\x00\x00\x00\x00\x00\x0e'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x078\x00\x00\x00\x00\x00\x00\x00\x0e'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x078\x00\x00\x00\x00\x00\x00\x00\x0e'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff?\x00\x00\x00\x00\x00\x00\x00\x0e'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\x07\x00\x00\x00\x00\x00\x00\x0e'
        b'\xf8\x0f\x00\x0f\xf0?\xf0?\x00\x1e\xc0\x7f\xc0\xff\x00\xff\xff\x07\x00\x00\x00\x00\x00\x00\x0e'
        b'\xf8\x0f\x80\x0f\xf0?\xf0?\x00\x1f\xc0\x7f\xc0\xff\x00\xc3\xff\xf0\x0f\x00\x00\x00\x00\xc0\x01'
        b'\xfc?\xc0\x0f\xfc\xff\xfc\xff\x80\x1f\xe0\xff\xf1\xff\x03\xc3\xe1\xf0\x0f\x00\x00\x00\x00\x80\x01'
        b'\xfcy\xf0\x1f\xfc\xe3\xfc\xe3\xe0?\xe0\xcf\xf3\x1f\x00\xc3\xe1\xf0\x0f\x00\x00\x00\x00\x80\x01'
        b'\xfc8\xf0\x1f\xfc\xe3\xfc\xe3\xe0?\xe0\xc7\xf1\x1f\x00\xc0\xe0px\x00\x00\x00\x00\x80\x01'
        b'\xff8\xf0\x1f\xfc\xe3\xfc\xf3\xe0?\xf8\xc7\xf1\x1f\x00\xf8\xe0pp\x00\x00\x00\x00\x80\x01'
        b'\xff\x00\xf8\x7f\xfc\xff\xfc?\xf0\xff\xf8\x07\xf0\xff\x00\xf8\xe0pp\x00\x00\x00\x00\x80\x01'
        b'\xff\x00\xb8\x7f\xfc\x7f\xfc;p\xff\xf8\x07\xf0?\x00\xe0\xe0\x0f\xc0\x7f\x00\x00\x008\x00'
        b'\xffx\x18\x7f\xfc?\xfc\xf30\xfe\xf8\xc7\xf3\x1f\x00\xe0\xe0\x0f\xc0\x7f\x00\x00\x008\x00'
        b'\xfcx\xb8\x7f\xfc\x7f\xfc\xe3p\xff\xe0\xc7\xf3\x1f\x00\xe08\x0e\xc0\x7f\x00\x00\x008\x00'
        b'\xfcy\xf8\xff\xfc\xff\xfc\xe3\xf0\xff\xe1\xcf\xf3\x1f\x00\xe08\x00\x00\x9e\x03\x00\x00\x06\x00'
        b'\xfc\x7f\xfe\xff\xfc\xf3\xfc\xff\xfc\xff\xe1\xff\xf3\xff\x03\xe08\x00\x00\x9e\x03\x00\x00\x06\x00'
        b'\xf8\x7f>\xfc\xf0\xf3\xf0?|\xf8\xc1\xff\xc3\xff\x00\xe0\x07\x00\x00\x9c\x03\x00\x00\x01\x00'
        b'\xf8\x7f\x1e\xf8\xf0\xf3\xf0?<\xf0\xc1\xff\xc3\xff\x00\xe0\x07\x00\x00\x8c\x03\x00\xc0\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x07\x00\x00\x8c\x03\x00\xc0\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\x00\x00p\x00\x008\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\x00\x80s\x00\x008\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\x00\x80s\x00\x008\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00p\x0e\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00p\x0e\x00\xf8\x07\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00p\x0e\x00\xf8\x07\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x80\x81\x01\xfc\x03\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x80\x81\x01\xfc\x03\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x80\x01\x00\xfc\x03\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x0e>\xfc\x03\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x0e>\xfc\x03\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\xfeq\xfc\x03\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xc0\xf9\xf1\x03\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xc0\xf9\xf1\x03\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x00\xc7\x01\x00\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\x00\x86\x0f\x00\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\x00\x86\x0f\x00\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8?>\x00\x00\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8?>\x00\x00\x00\x00\x00\x00\x00'
        b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8?>\x00\x00\x00\x00\x00\x00\x00'
    )
    epd = EPD_DRIVER(spi)
    epd.change_image(img)


def run():
    try:
        pixels = neopixel.NeoPixel(board.NEOPIXEL, 4, brightness=0.25, auto_write=True)

        displayio.release_displays()
        d_spi = SPI(board.EINK_CLKS, board.EINK_MOSI, board.EINK_MISO)
        lcd_fw = FourWire(d_spi, command=board.TFT_DC, chip_select=board.TFT_CS, reset=board.TFT_RST, baudrate=20000000)
        lcd = ST7735R(lcd_fw, width=128, height=128, colstart=2, rowstart=1, rotation=270)

        test_neopixels(pixels)
        print()
        test_buttons(pixels)
        print()
        test_epd(d_spi)
        print()
        pixels.fill(0xFF0000)
        print("Test successful!")
        print("----------------")
        loop_forever()
    except Exception as e:
        print("Test failed!")
        print("------------")
        print_exception(e)
        try:
            pixels.fill(0x00FF00)
        except:
            pass
        loop_forever()

run()